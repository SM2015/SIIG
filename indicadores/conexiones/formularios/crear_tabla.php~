<?php
include_once("../../addons/general/general.php");
$id= 	(isset($_REQUEST['id'])) ? $_REQUEST['id'] : NULL;
$cnx=bdd_conectar();
$q="SELECT * FROM form_".$id;
if ($rs = @pg_query($cnx, $q)){
	$num = bdd_pg_num_rows($rs);
	if ($num==0){
		$q="DROP TABLE form_".$id;
		@pg_query($cnx,$q);
		creartabla($id,$cnx);
		print "La tabla se ha actualizado satisfactoriamente";

	}else{
		print "La tabla ya existe y tiene datos";
	}
}else{
	creartabla($id,$cnx);
print "La tabla se ha creado satisfactoriamente";

}


function creartabla($id,$cnx){
$q='SELECT id_form, nombre, menu_publicacion, comentario, nombre_tabla
  FROM form where id_form='.$id;
$rs = bdd_pg_query($cnx, $q);
$regf = bdd_pg_fetch_row($rs);
$q="
SELECT form_cat.id_cat as id, 	form_cat.orden as orden, catalogos.campo_llave as nombre, '2' as tipo , 0 as tamano, 1 as tipoc
FROM public.catalogos, public.form_cat
WHERE catalogos.id_cat = form_cat.id_cat and form_cat.id_form= ".$id." 
union 
SELECT id_campo as id, 	orden_campo as orden, 	nombre_campo_t as nombre, tipo_campo as tipo, tamano_campo as tamano	, 2 as tipoc
FROM form_campos where id_form=".$id."
order by orden";
$rs = bdd_pg_query($cnx, $q);

$q="SET statement_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = off;
SET check_function_bodies = false;
SET client_min_messages = warning;
SET escape_string_warning = off;
SET search_path = public, pg_catalog;
SET default_tablespace = '';
SET default_with_oids = false;
CREATE TABLE form_".$id." (
    id_".$id." integer NOT NULL ";
while ($regc = bdd_pg_fetch_row($rs)){
	if($regc[3]=='2'){
		$q=$q." , ".$regc[2]." integer NOT NULL";
	}else{
		$q=$q." , ".$regc[2]." character varying(".$regc[4].") NOT NULL";
	}
}
$q=$q.");
ALTER TABLE public.form_".$id." OWNER TO admin;
COMMENT ON TABLE form_".$id." IS '".$regf[3]."';
CREATE SEQUENCE form_".$id."_id_".$id."_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;
ALTER TABLE public.form_".$id."_id_".$id."_seq OWNER TO admin;
ALTER SEQUENCE form_".$id."_id_".$id."_seq OWNED BY form_".$id.".id_".$id.";
ALTER TABLE form_".$id." ALTER COLUMN id_".$id." SET DEFAULT nextval('form_".$id."_id_".$id."_seq'::regclass);
ALTER TABLE ONLY form_".$id."
ADD CONSTRAINT id_".$id." PRIMARY KEY (id_".$id."); ";
//print $q;
@pg_exec($cnx, $q)or die(pg_errormessage());




}
?>
<label for="Add">&nbsp;</label>
				<br/><br/><br/>
				<input tabindex="10" class="frm-btn-x" type="button" name="cancel" title="Cancelar" id="Cancel" value="Generar Formulario" onclick="javascript:window=('/indicadores/conexiones/form_usuarios/index.php?id=<?php echo $id; ?>');" /><br/><br/>